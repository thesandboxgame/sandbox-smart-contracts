# Asset Create Contract Documentation

This document serves as comprehensive documentation for the AssetCreate
contract, which is responsible for creating new assets in The Sandbox ecosystem.
It outlines the contract's roles, public variables, and functions, providing
details on their purposes, parameters, and access controls.

## Roles in the Contract

1. **DEFAULT_ADMIN_ROLE**: The role with broad administrative permissions,
   including setting URIs and changing the trusted forwarder.
2. **SPECIAL_MINTER_ROLE**: The special minter role with permission to create
   special assets like TSB exclusive tokens.
3. **PAUSER_ROLE**: The role with permission to pause the contract.

## Public Variables

1. `assetContract`: The address of the asset contract.
2. `catalystContract`: The address of the catalyst contract.
3. `authValidator`: The address of the AuthSuperValidator contract.
4. `creatorNonces`: A public mapping from address to uint16, representing the
   creator's nonce. The nonce is incremented every time a creator mints a new
   token.
5. `signatureNonces`: A public mapping from address to uint16, representing the
   signature's nonce. The nonce is incremented for each signature generated by
   the address.
6. `lazyMintFee`: The fee charged for lazy minting, represented in BPS.
7. `lazyMintFeeReceiver`: The address that receives the lazy minting fee.
8. `availableToMint`: A mapping from uint256 to uint256, representing the amount
   of assets available to lazy mint for given tokenId.

## Functions

### initialize

```solidity
function initialize(
    string memory name,
    string memory version,
    address assetContract,
    address catalystContract,
    address authValidator,
    address forwarder,
    address defaultAdmin
) external
```

Initializes the contract with the specified parameters at the time of
deployment.

Parameters:

- `name`: The name of the contract.
- `version`: The version of the contract.
- `assetContract`: The address of the asset contract.
- `catalystContract`: The address of the catalyst contract.
- `authValidator`: The address of the AuthSuperValidator contract.
- `forwarder`: The address of the trusted forwarder for meta-transactions.
- `defaultAdmin`: The address that will be granted the DEFAULT_ADMIN_ROLE.

### createAsset

```solidity
function createAsset(
    bytes memory signature,
    uint8 tier,
    uint256 amount,
    bool revealed,
    string calldata metadataHash,
    address creator
) external
```

Creates a new asset and associates it with the provided metadata hash. The asset
is minted to the creator's address.

Parameters:

- `signature`: A signature generated by TSB for authentication.
- `tier`: The tier of the asset to mint.
- `amount`: The amount of the asset to mint.
- `revealed`: A boolean indicating whether the asset is revealed or hidden.
- `metadataHash`: The IPFS metadata hash associated with the asset.
- `creator`: The address of the asset creator.

### createMultipleAssets

```solidity
function createMultipleAssets(
    bytes memory signature,
    uint8[] calldata tiers,
    uint256[] calldata amounts,
    bool[] calldata revealed,
    string[] calldata metadataHashes,
    address creator
) external
```

Creates multiple assets at once and associates them with the provided metadata
hashes. The assets are minted to the creator's address.

Parameters:

- `signature`: A signature generated by TSB for authentication.
- `tiers`: An array containing the tiers of the assets to mint.
- `amounts`: An array containing the amount of each asset to mint.
- `revealed`: An array of booleans indicating whether each asset is revealed or
  hidden.
- `metadataHashes`: An array containing the IPFS metadata hashes associated with
  the assets.
- `creator`: The address of the asset creator.

### createSpecialAsset

```solidity
function createSpecialAsset(
    bytes memory signature,
    uint256 amount,
    string calldata metadataHash,
    address creator
) external onlyRole(SPECIAL_MINTER_ROLE)
```

Creates a special tier 0 TSB exclusive asset and associates it with the provided
metadata hash. This function can only be called by the address with the
SPECIAL_MINTER_ROLE. This function mints the assets as revealed.

Parameters:

- `signature`: A signature generated by TSB for authentication.
- `amount`: The amount of the asset to mint.
- `metadataHash`: The IPFS metadata hash associated with the asset.
- `creator`: The address of the asset creator.

### getAssetContract

```solidity
function getAssetContract() external view returns (address)
```

Returns the address of the asset contract.

### getCatalystContract

```solidity
function getCatalystContract() external view returns (address)
```

Returns the address of the catalyst contract.

### getAuthValidator

```solidity
function getAuthValidator() external view returns (address)
```

Returns the address of the AuthSuperValidator contract.

### setTrustedForwarder

```solidity
function setTrustedForwarder(address trustedForwarder) external onlyRole(DEFAULT_ADMIN_ROLE)
```

Sets a new trusted forwarder for meta-transactions. This function is limited to
addresses with the DEFAULT_ADMIN_ROLE.

Parameters:

- `trustedForwarder`: The new trusted forwarder address.

## Internal Functions

### \_hashMint

```solidity
function _hashMint(
    address creator,
    uint16 nonce,
    uint8 tier,
    uint256 amount,
    bool revealed,
    string calldata metadataHash
) internal view returns (bytes32 digest)
```

Creates a hash of the mint data for signature verification.

Parameters:

- `creator`: The address of the creator.
- `nonce`: The creator's nonce for the mint operation.
- `tier`: The tier of the asset to mint.
- `amount`: The amount of the asset to mint.
- `revealed`: A boolean indicating whether the asset is revealed or hidden.
- `metadataHash`: The IPFS metadata hash associated with the asset.

Returns:

- `digest`: The hash of the mint data.

### \_hashBatchMint

```solidity
function _hashBatchMint(
    address creator,
    uint16 nonce,
    uint8[] calldata tiers,
    uint256[] calldata amounts,
    bool[] calldata revealed,
    string[] calldata metadataHashes
) internal view returns (bytes32 digest)
```

Creates a hash of the mint batch data for signature verification.

Parameters:

- `creator`: The address of the creator.
- `nonce`: The creator's nonce for the mint batch operation.
- `tiers`: An array containing the tiers of the assets to mint.
- `amounts`: An array containing the amount of each asset to mint.
- `revealed`: An array of booleans indicating whether each asset is revealed or
  hidden.
- `metadataHashes`: An array containing the IPFS metadata hashes associated with
  the assets.

Returns:

- `digest`: The hash of the mint batch data.

### \_encodeHashes

```solidity
function _encodeHashes(string[] memory metadataHashes) internal pure returns (bytes32)
```

Encodes the hashes of the metadata for signature verification.

Parameters:

- `metadataHashes`: An array containing the IPFS metadata hashes associated with
  the assets.

Returns:

- `encodedHashes`: The encoded hashes of the metadata.

### \_msgSender

```solidity
function _msgSender() internal view virtual override(ContextUpgradeable, ERC2771Handler) returns (address sender)
```

Internal function to get the message sender address for meta-transactions.

Returns:

- `sender`: The address of the sender.

### \_msgData

```solidity
function _msgData() internal view virtual override(ContextUpgradeable, ERC2771Handler) returns (bytes calldata)
```

Internal function to get the message data for meta-transactions.

Returns:

- `calldata`: The message data.

## Lazy Minting Functions

Lazy minting allows creators to list the assets for sale without minting them in
advance. The assets are minted only when a buyer purchases them.

Important notes

- Users should be able to mint assets based on voxel models listed by the
  creators. Note: the asset cannot have been minted already using regular
  minting.
- The unit price is specified by the creator off-chain and is passed as a
  parameter to the lazy minting function.
- To lazy mint users need to either have the required catalysts in their wallet
  or purchase them in the process of minting.
- The ExchangeMatch param in the lazy mint functions will be populated by the
  backend.
- The ExchangeMatch param should be set to empty array if the user is not
  purchasing the catalysts in the process of minting.
- The creator can specify the maximum supply of the asset.
- The creator can specify the payment token for the asset. (initially only SAND)
- A fee may be deducted from the creator's fee for lazy minting operations.
- Catalysts are burned in the process of minting.

The following functions are used for lazy minting:

### lazyCreateAsset

```solidity
function lazyCreateAsset(
  address from,
  bytes memory signature,
  LazyMintData calldata mintData,
  ExchangeMatch[] calldata matchedOrders
)
```

Creates a new asset through lazy minting and associates it with the provided
metadata hash. The asset is minted to the callers's address.

Burns catalyst from the callers wallet. Allows minting only up to the
availableToMint amount. Caller needs to pay the price specified by the creator.
A TSB fee may be deducted from the creator's fee.

Parameters:

- `from`: The address of the caller.
- `signature`: A signature generated by TSB for authentication.
- `mintData - LazyMintData`: The data required for minting the asset.
- `matchedOrdersArray`: An array of ExchangeMatch arrays in case Catalysts are
  being purchased in the process of minting.

### lazyCreateMultipleAssets

```solidity
function lazyCreateMultipleAssets(
  address from,
  bytes memory signature,
  LazyMintBatchData calldata mintData,
  ExchangeMatch[][] calldata matchedOrdersArray
)
```

Creates multiple assets through lazy minting and associates them with the
provided metadata hashes. The assets are minted to the caller's address.

Parameters:

- `from`: The address of the caller.
- `signature`: A signature generated by TSB for authentication.
- `mintData - LazyMintBatchData`: The data required for minting the assets.
- `matchedOrdersArray`: An array of ExchangeMatch arrays in case Catalysts are
  being purchased in the process of minting.

### distributePayment

```solidity
function distributePayment(
      uint256 unitPrice,
      uint256 amount,
      address paymentToken,
      address creator
  )
```

Splits the lazy minting payment between the creator and TSB.

Parameters:

- `unitPrice`: The price per unit of the asset.
- `amount`: The amount of the asset to mint.
- `paymentToken`: The address of the payment token.
- `creator`: The address of the asset creator.

### \_hashLazyMint

```solidity
    function _hashLazyMint(
        address caller,
        address creator,
        uint16 nonce,
        uint8 tier,
        uint256 amount,
        uint256 unitPrice,
        address paymentToken,
        string memory metadataHash,
        uint256 maxSupply
    )
```

Creates a hash of the lazy mint data for signature verification.

Parameters:

- `caller`: The address of the caller.
- `creator`: The address of the creator.
- `nonce`: The caller's nonce for the lazy mint operation.
- `tier`: The tier of the asset to mint.
- `amount`: The amount of the asset to mint.
- `unitPrice`: The price per unit of the asset.
- `paymentToken`: The address of the payment token.
- `metadataHash`: The IPFS metadata hash associated with the asset.
- `maxSupply`: The maximum supply of the asset.

### \_hashLazyBatchMint

```solidity
    function _hashLazyBatchMint(
        address caller,
        address[] memory creators,
        uint16 nonce,
        uint8[] memory tiers,
        uint256[] memory amounts,
        uint256[] memory unitPrices,
        address[] memory paymentTokens,
        string[] memory metadataHashes,
        uint256[] memory maxSupplies
    )
```

Creates a hash of the lazy mint batch data for signature verification.

Parameters:

- `caller`: The address of the caller.
- `creators`: An array containing the addresses of the creators.
- `nonce`: The caller's nonce for the lazy mint batch operation.
- `tiers`: An array containing the tiers of the assets to mint.
- `amounts`: An array containing the amount of each asset to mint.
- `unitPrices`: An array containing the price per unit of each asset.
- `paymentTokens`: An array containing the addresses of the payment tokens.
- `metadataHashes`: An array containing the IPFS metadata hashes associated with
  the assets.
- `maxSupplies`: An array containing the maximum supplies of the assets.

### setLazyMintFee

```solidity
 function setLazyMintFee(uint256 _lazyMintFee)
```

Sets the fee charged for lazy minting. Only callable by admin.

Parameters:

- `_lazyMintFee`: The fee charged for lazy minting, represented in BPS.

### setLazyMintFeeReceiver

```solidity
function setLazyMintFeeReceiver(address _lazyMintFeeReceiver)
```

Sets the address that receives the lazy minting fee. Only callable by admin.

Parameters:

- `_lazyMintFeeReceiver`: The address that receives the lazy minting fee.

### setExchangeContract

```solidity
function setExchangeContract(address _exchangeContract)
```

## Sets the address of the exchange contract. Only callable by admin.

This documentation provides an overview of the AssetCreate contract and its
functionalities. Developers can refer to this document to understand the
contract's behavior, its purpose, and the functions available for creating new
assets in The Sandbox ecosystem.

---
