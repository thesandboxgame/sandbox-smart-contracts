name: CI
on: pull_request
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/setup"

      - name: Linting
        run: yarn lint:ci

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/setup"

      - name: Formatting
        run: yarn format:ci

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/setup"

      - name: Running tests
        run: yarn test:ci


  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/setup"

      - name: Running coverage
        run: yarn coverage:ci

      - name: Report coverage
        uses: adjisb/code-coverage-assistant@master
        with:
          monorepo-base-path: "./packages"
          exclude: "core"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          min_coverage: 90
          badge_path: "./badges"

      - name: Deploy badges
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./badges

  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/setup"

      - name: Deploy contracts
        run: yarn deploy:ci
        env:
          ETH_NODE_URI_GOERLI: ${{ secrets.ETH_NODE_URI_GOERLI }}
